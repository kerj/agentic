#!/bin/bash
# ~/.agentic/bin/agentic-switch
# Toggle between Anthropic and Ollama/Qwen configurations
# Usage: agentic-switch [anthropic|ollama|status]

CONF="$AGENTIC_HOME/.agentic.conf"

# ── Helpers ────────────────────────────────────────────────────────────────

_current_provider() {
  local url="${ANTHROPIC_BASE_URL:-}"
  if [[ "$url" == *"anthropic.com"* ]]; then
    echo "anthropic"
  elif [[ -n "$url" ]]; then
    echo "ollama"
  else
    echo "unknown"
  fi
}

_show_current() {
  local provider=$(_current_provider)
  echo "Current provider: $provider"
  echo ""
  echo "  AGENTIC_MODEL:        ${AGENTIC_MODEL:-not set}"
  echo "  ANTHROPIC_BASE_URL:   ${ANTHROPIC_BASE_URL:-not set}"
  if [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
    echo "  ANTHROPIC_API_KEY:    ${ANTHROPIC_API_KEY:0:12}..."
  else
    echo "  ANTHROPIC_API_KEY:    not set"
  fi
  echo "  ANTHROPIC_AUTH_TOKEN: ${ANTHROPIC_AUTH_TOKEN:-not set}"
}

_resolve_api_key() {
  local key=""

  # 1. Try reading live value from conf file (double-quoted format)
  key=$(grep 'ANTHROPIC_API_KEY=' "$CONF" 2>/dev/null \
    | grep -v '^#' \
    | grep -v 'unset' \
    | head -1 \
    | cut -d'"' -f2)

  # 2. Try reading stashed comment left by _switch_to_ollama
  if [[ -z "$key" ]]; then
    key=$(grep '^# ANTHROPIC_API_KEY=' "$CONF" 2>/dev/null \
      | head -1 \
      | cut -d'"' -f2)
  fi

  # 3. Fall back to current shell environment
  if [[ -z "$key" ]]; then
    key="${ANTHROPIC_API_KEY:-}"
  fi

  # 4. Prompt if still not found
  if [[ -z "$key" ]]; then
    echo "⚠️  No ANTHROPIC_API_KEY found in conf or environment" >&2
    read -p "Enter your Anthropic API key: " key
    if [[ -z "$key" ]]; then
      echo "❌ No key provided" >&2
      return 1
    fi
  fi

  echo "$key"
}

_switch_to_anthropic() {
  local existing_key
  existing_key=$(_resolve_api_key) || return 1

  cat > "$CONF" << EOF
# ── Anthropic ──────────────────────────────────────────────────────────────
export AGENTIC_MODEL="claude-opus-4-20250514"
export ANTHROPIC_BASE_URL="https://api.anthropic.com"
export ANTHROPIC_API_KEY="$existing_key"
unset ANTHROPIC_AUTH_TOKEN

export OLLAMA_MAX_LOADED_MODELS=3
export OLLAMA_KEEP_ALIVE="30m"
EOF

  chmod 600 "$CONF"
  echo "✅ Switched to Anthropic (claude-opus-4-20250514)"
  echo "   Run: source \$AGENTIC_HOME/.agentic.conf"
}

_switch_to_ollama() {
  # Stash the API key before overwriting conf so switching back works without prompting
  local stashed_key
  stashed_key=$(_resolve_api_key 2>/dev/null || true)

  cat > "$CONF" << 'EOF'
# ── Ollama / Qwen ──────────────────────────────────────────────────────────
export AGENTIC_MODEL="qwen2.5-coder:32b"
export ANTHROPIC_BASE_URL="http://localhost:11434"
export ANTHROPIC_AUTH_TOKEN="ollama"
unset ANTHROPIC_API_KEY

export OLLAMA_MAX_LOADED_MODELS=3
export OLLAMA_KEEP_ALIVE="30m"
EOF

  # Stash key as a comment so switching back to Anthropic works without prompting
  if [[ -n "$stashed_key" ]]; then
    echo "" >> "$CONF"
    echo "# ANTHROPIC_API_KEY=\"$stashed_key\"" >> "$CONF"
  fi

  chmod 600 "$CONF"
  echo "✅ Switched to Ollama (qwen2.5-coder:32b)"
  echo "   Run: source \$AGENTIC_HOME/.agentic.conf"
}

# ── Main ───────────────────────────────────────────────────────────────────

case "${1:-}" in
  anthropic|claude)
    _switch_to_anthropic
    ;;
  ollama|qwen|local)
    _switch_to_ollama
    ;;
  status|"")
    _show_current
    echo ""
    echo "Usage:"
    echo "  agentic-switch anthropic   # Switch to Anthropic/Claude"
    echo "  agentic-switch ollama      # Switch to Ollama/Qwen"
    echo "  agentic-switch status      # Show current config"
    ;;
  *)
    echo "❌ Unknown option: $1"
    echo "Usage: agentic-switch [anthropic|ollama|status]"
    exit 1
    ;;
esac
